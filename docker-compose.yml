# Docker Compose for QuantConnect Trading Bot
# Provides isolated environments for different development phases

version: "3.8"

services:
  # Development sandbox - NO network access, strict isolation
  # Use for Phase 1: Code development and unit testing
  sandbox:
    build: .
    container_name: qc-sandbox
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M
    mem_limit: 2g
    cpus: 2
    network_mode: none
    volumes:
      - ./algorithms:/app/algorithms:rw
      - ./indicators:/app/indicators:rw
      - ./models:/app/models:rw
      - ./utils:/app/utils:rw
      - ./tests:/app/tests:rw
      - ./results:/app/results:rw
      - ./.backups:/app/.backups:rw
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    command: ["python", "-m", "pytest", "tests/", "-v", "--tb=short"]

  # Backtest environment - Limited network for LEAN data downloads
  # Use for Phase 2: Backtest validation
  backtest:
    build: .
    container_name: qc-backtest
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    mem_limit: 4g
    cpus: 4
    volumes:
      - ./algorithms:/app/algorithms:ro
      - ./indicators:/app/indicators:ro
      - ./models:/app/models:ro
      - ./utils:/app/utils:ro
      - ./results:/app/results:rw
      - ./data:/app/data:rw
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - QC_USER_ID=${QC_USER_ID}
      - QC_API_TOKEN=${QC_API_TOKEN}
    command: ["bash", "-c", "scripts/run_pipeline.sh"]

  # Paper trading validation - Network access to QuantConnect only
  # Use for Phase 3: Paper trading stress testing
  paper-trading:
    build: .
    container_name: qc-paper-trading
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    mem_limit: 2g
    cpus: 2
    volumes:
      - ./algorithms:/app/algorithms:ro
      - ./indicators:/app/indicators:ro
      - ./models:/app/models:ro
      - ./utils:/app/utils:ro
      - ./results:/app/results:rw
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - QC_USER_ID=${QC_USER_ID}
      - QC_API_TOKEN=${QC_API_TOKEN}
      - PAPER_TRADING=true
    # Network restricted to QuantConnect endpoints only
    # Configure via Docker network or firewall rules

  # Analysis and reporting environment
  analysis:
    build: .
    container_name: qc-analysis
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M
    mem_limit: 2g
    cpus: 2
    network_mode: none
    volumes:
      - ./results:/app/results:ro
      - ./reports:/app/reports:rw
    command: ["python", "scripts/analyze_results.py"]

  # Claude Code Autonomous Agent - Sandboxed overnight development
  # Use for autonomous coding sessions with external watchdog monitoring
  # Usage: docker-compose run --rm claude-agent -p "Your task here"
  claude-agent:
    build:
      context: .
      dockerfile: docker/Dockerfile.claude
    container_name: claude-overnight
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    # Read-only filesystem with writable temp dirs
    read_only: true
    tmpfs:
      - /tmp:size=500M
      - /var/tmp:size=100M
    mem_limit: 4g
    cpus: 2
    volumes:
      # Project workspace (read-write for coding)
      - .:/workspace:rw
      # Claude config (read-only for safety)
      - ~/.claude:/home/claude/.claude:ro
      # Progress file for watchdog communication
      - ./claude-progress.txt:/workspace/claude-progress.txt:rw
      # Logs directory
      - ./logs:/workspace/logs:rw
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - QC_USER_ID=${QC_USER_ID}
      - QC_API_TOKEN=${QC_API_TOKEN}
      - PYTHONUNBUFFERED=1
    # Use isolated network (no external access except API)
    networks:
      - claude-isolated
    # Health check for watchdog integration
    healthcheck:
      test: ["CMD", "pgrep", "-f", "claude"]
      interval: 30s
      timeout: 10s
      retries: 3
    stdin_open: true
    tty: true

# Networks for environment isolation
networks:
  sandbox:
    driver: bridge
    internal: true  # No external access
  backtest:
    driver: bridge
  paper-trading:
    driver: bridge
  claude-isolated:
    driver: bridge
    # Note: Not internal: true because Claude needs API access
    # Use firewall rules to restrict to anthropic.com only if needed
